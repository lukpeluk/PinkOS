#include "videoDriver.h"
#include <stdint.h>

struct vbe_mode_info_structure {
	uint16_t attributes;		// deprecated, only bit 7 should be of interest to you, and it indicates the mode supports a linear frame buffer.
	uint8_t window_a;			// deprecated
	uint8_t window_b;			// deprecated
	uint16_t granularity;		// deprecated; used while calculating bank numbers
	uint16_t window_size;
	uint16_t segment_a;
	uint16_t segment_b;
	uint32_t win_func_ptr;		// deprecated; used to switch banks from protected mode without returning to real mode
	uint16_t pitch;			// number of bytes per horizontal line
	uint16_t width;			// width in pixels
	uint16_t height;			// height in pixels
	uint8_t w_char;			// unused...
	uint8_t y_char;			// ...
	uint8_t planes;
	uint8_t bpp;			// bits per pixel in this mode
	uint8_t banks;			// deprecated; total number of banks in this mode
	uint8_t memory_model;
	uint8_t bank_size;		// deprecated; size of a bank, almost always 64 KB but may be 16 KB...
	uint8_t image_pages;
	uint8_t reserved0;
 
	uint8_t red_mask;
	uint8_t red_position;
	uint8_t green_mask;
	uint8_t green_position;
	uint8_t blue_mask;
	uint8_t blue_position;
	uint8_t reserved_mask;
	uint8_t reserved_position;
	uint8_t direct_color_attributes;
 
	uint32_t framebuffer;		// physical address of the linear frame buffer; write here to draw to the screen
	uint32_t off_screen_mem_off;
	uint16_t off_screen_mem_size;	// size of memory in the framebuffer but not being displayed on the screen
	uint8_t reserved1[206];
} __attribute__ ((packed));

typedef struct vbe_mode_info_structure * VBEInfoPtr;

VBEInfoPtr VBE_mode_info = (VBEInfoPtr) 0x0000000000005C00;

void putPixel(uint32_t hexColor, uint64_t x, uint64_t y) {
    uint8_t * framebuffer = (uint8_t *) VBE_mode_info->framebuffer;
    uint64_t offset = (x * ((VBE_mode_info->bpp)/8)) + (y * VBE_mode_info->pitch);
    framebuffer[offset]     =  (hexColor) & 0xFF;
    framebuffer[offset+1]   =  (hexColor >> 8) & 0xFF; 
    framebuffer[offset+2]   =  (hexColor >> 16) & 0xFF;
}


// a character table and a print function for video mode (bitmaps)
// the font is here, not in a separate file


#define CHAR_WIDTH 8
#define CHAR_HEIGHT 16
#define FONT_NOF_CHARS 95

// TODO: separar las fuentes en archivos separados
// Y capaz que sean otro tipo de estructura, no un array de arrays, porque no todas las fuentes van a tener todos los chars
// (queremos que si uno no lo tiene use un �)

uint8_t font2[2][16] = {
    // Character ' ' (space)
    {
        0b11111111, 
		0b10000001, 
		0b10000000, 
		0b10000000,
        0b10000000, 
		0b10000000, 
		0b10000000, 
		0b10000000,
        0b10000000, 
		0b10000000, 
		0b10000000, 
		0b10000000,
        0b10000000, 
		0b10000000, 
		0b10000001, 
		0b11111111
    },
    // Character 'A'
    {
        0b00011000, 0b00111100, 0b01100110, 0b11000011,
        0b11000011, 0b11111111, 0b11000011, 0b11000011,
        0b11000011, 0b11000011, 0b11000011, 0b00000000,
        0b00000000, 0b00000000, 0b00000000, 0b00000000
    },
    // Add more characters as needed...
};

uint8_t font_test_photoshop[][16] = {
    // Character 'test-a'
    { 0b00000000, 0b00010100, 0b00011000, 0b00011000, 0b00111000, 0b00111100, 0b01111100, 0b01101100, 0b01101110, 0b11111111, 0b11111111, 0b11000111, 0b11000011, 0b11000011, 0b10000000, 0b00000000 },
    // Character 'test-b'
    { 0b00000000, 0b00000000, 0b01100000, 0b01100000, 0b01100000, 0b01100000, 0b01100000, 0b01110000, 0b01111110, 0b01111110, 0b01100110, 0b01100111, 0b01111110, 0b01111100, 0b00000000, 0b00000000 },
};

// Pink Panther font
uint8_t pink_panther_font[][16] = {
    // Character 'K'
    { 0b00001111, 0b11100011, 0b10000100, 0b10000100, 0b10001000, 0b10011000, 0b10110000, 0b11100000, 0b11110000, 0b10110000, 0b10011000, 0b10011000, 0b10001100, 0b10001110, 0b10000111, 0b11100000 },
    // Character 'J'
    { 0b00111111, 0b00001100, 0b00001100, 0b00001100, 0b00001100, 0b00000100, 0b00001100, 0b00001100, 0b00001100, 0b00000100, 0b00001110, 0b10001100, 0b10001100, 0b11001100, 0b10110000, 0b00000000 },
    // Character 'H'
    { 0b00011111, 0b11000110, 0b10000110, 0b10000110, 0b10000110, 0b10000110, 0b10000110, 0b10000110, 0b10000110, 0b11111110, 0b10000110, 0b10000110, 0b10000110, 0b10000110, 0b10001111, 0b11100000 },
    // Character 'I'
    { 0b01111100, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b00110000, 0b11111000 },
    // Character 'Z'
    { 0b11111111, 0b11000110, 0b11000110, 0b01001100, 0b10001100, 0b10011000, 0b00011000, 0b00110001, 0b00110001, 0b01100010, 0b01100011, 0b11000011, 0b11000011, 0b11111110, 0b00000000, 0b00000000 },
    // Character 'M'
    { 0b00000011, 0b10000011, 0b11000011, 0b11000111, 0b11000111, 0b11100101, 0b11100101, 0b01101011, 0b10111011, 0b10111001, 0b10110011, 0b10011011, 0b10010001, 0b10000011, 0b10001111, 0b11000000 },
    // Character 'L'
    { 0b11111000, 0b01100000, 0b01100000, 0b01100000, 0b01100000, 0b01100000, 0b01100000, 0b01100001, 0b01100001, 0b01100010, 0b01100011, 0b01100011, 0b01100011, 0b11101111, 0b00101000, 0b00000000 },
    // Character 'Y'
    { 0b00001111, 0b11100010, 0b11000010, 0b01100100, 0b01100100, 0b01100100, 0b00111000, 0b00111000, 0b00010000, 0b00011000, 0b00010000, 0b00011000, 0b00011000, 0b00111000, 0b11111100, 0b00000000 },
    // Character 'N'
    { 0b10001111, 0b11100010, 0b01100010, 0b01100010, 0b10110010, 0b01010010, 0b00110010, 0b10011000, 0b01001010, 0b10001110, 0b01001110, 0b10000110, 0b10000110, 0b10000110, 0b11000010, 0b11100010 },
    // Character 'O'
    { 0b00010100, 0b00100010, 0b01100010, 0b01000011, 0b11000011, 0b11000011, 0b11000011, 0b11000001, 0b11000011, 0b11000011, 0b11000011, 0b11000011, 0b11000011, 0b01000010, 0b01000110, 0b00111000 },
    // Character 'X'
    { 0b00001111, 0b11110010, 0b11000110, 0b01100100, 0b01100100, 0b00111000, 0b00111000, 0b00010000, 0b00011000, 0b00111000, 0b00101100, 0b01001100, 0b01000110, 0b10000110, 0b11001111, 0b11100000 },
    // Character 'U'
    { 0b00001111, 0b11110010, 0b11000010, 0b10000010, 0b11000010, 0b10000010, 0b11000010, 0b10000010, 0b11000010, 0b10000010, 0b10000010, 0b11000010, 0b10000010, 0b11000100, 0b01000100, 0b00111000 },
    // Character 'B'
    { 0b11111110, 0b01100011, 0b01100011, 0b01100001, 0b01100011, 0b01100001, 0b00110011, 0b01111110, 0b00100011, 0b01100011, 0b00100001, 0b00110011, 0b01100011, 0b11111100, 0b00000000, 0b00000000 },
    // Character 'C'
    { 0b00110010, 0b01000110, 0b01000110, 0b11000010, 0b11000010, 0b11000010, 0b11000000, 0b11000000, 0b11000000, 0b11000000, 0b11000000, 0b11000001, 0b11000010, 0b01000010, 0b01100110, 0b00011010 },
    // Character 'T'
    { 0b11111111, 0b10011011, 0b10011001, 0b00111001, 0b00010001, 0b00011001, 0b00011000, 0b00110000, 0b00011000, 0b00010000, 0b00011000, 0b00010000, 0b00010000, 0b00111000, 0b01010100, 0b00000000 },
    // Character 'V'
    { 0b01001111, 0b11000010, 0b10000100, 0b10000100, 0b10000100, 0b11000100, 0b11001000, 0b01001000, 0b01101000, 0b01100000, 0b01110000, 0b01110000, 0b00100000, 0b00100000, 0b00100000, 0b00100000 },
    // Character 'A'
    { 0b11111000, 0b00111000, 0b00011100, 0b00111100, 0b00101100, 0b00101100, 0b01000110, 0b01000110, 0b01000110, 0b01111110, 0b01000011, 0b10000011, 0b11000011, 0b10001111, 0b11100000, 0b00000000 },
    // Character 'W'
    { 0b00000011, 0b10010000, 0b00010001, 0b00011000, 0b00111001, 0b00011001, 0b00101001, 0b10101101, 0b10101101, 0b11001110, 0b11000110, 0b11000110, 0b11000110, 0b11000100, 0b01000100, 0b00000000 },
    // Character 'D'
	{ 0b11111000, 0b11000110, 0b11000110, 0b11000011, 0b11000011, 0b11000011, 0b11000011, 0b11000011, 0b01000011, 0b11000011, 0b01000011, 0b11000110, 0b01000110, 0b11001100, 0b11110000, 0b00000000 },
    // Character 'S'
    { 0b00111010, 0b01000110, 0b11000110, 0b10000010, 0b11000010, 0b10000010, 0b11000010, 0b11100000, 0b01110000, 0b00011000, 0b00001110, 0b00000110, 0b10000110, 0b10000110, 0b11000100, 0b10111000 },
    // Character 'R'
    { 0b11111000, 0b11001100, 0b11000110, 0b10000110, 0b11000110, 0b11000110, 0b10000110, 0b11000110, 0b10001100, 0b11111000, 0b11010000, 0b10011000, 0b11011000, 0b10001100, 0b10000110, 0b11100101 },
    // Character 'E'
    { 0b11111111, 0b01100011, 0b01110001, 0b00100001, 0b01110001, 0b00100000, 0b01110100, 0b00110100, 0b01101100, 0b00100101, 0b00110001, 0b00100001, 0b01100001, 0b11111111, 0b00000000, 0b00000000 },
    // Character 'G'
    { 0b00110010, 0b11001110, 0b10000110, 0b10000100, 0b10000010, 0b10000000, 0b10000000, 0b10001010, 0b10011110, 0b10000110, 0b10000110, 0b10000110, 0b10000110, 0b11001110, 0b00101010, 0b00000000 },
    // Character 'P'
    { 0b11111000, 0b11000110, 0b11000011, 0b11000011, 0b11000011, 0b11000011, 0b11000011, 0b11000111, 0b11000110, 0b11111000, 0b11000000, 0b11000000, 0b01000000, 0b11000000, 0b11000000, 0b11110000 },
    // Character 'Q'
    { 0b00011000, 0b01100100, 0b01000010, 0b11000010, 0b11000011, 0b11000011, 0b10000011, 0b11000011, 0b10000011, 0b11000011, 0b11000011, 0b11000011, 0b11000010, 0b01000110, 0b01101100, 0b00111100 },
    // Character 'F'
    { 0b11111111, 0b01100011, 0b01110001, 0b01100001, 0b00110001, 0b01100001, 0b00110100, 0b01100100, 0b00111110, 0b00100100, 0b01100010, 0b00100000, 0b00110000, 0b00100000, 0b01110000, 0b10101000 },
};

// retro font
uint8_t retro_font[][16] = {
    // Character '0'
    { 0b00000000, 0b01111100, 0b11101110, 0b10000010, 0b10000111, 0b10011110, 0b10111010, 0b11100011, 0b11100010, 0b10000010, 0b11101110, 0b01111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character '1'
    { 0b00000000, 0b00010000, 0b00110000, 0b01110000, 0b00011000, 0b00010000, 0b00010000, 0b00010000, 0b00011000, 0b00010000, 0b00111000, 0b01111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character '2'
    { 0b00000000, 0b01111100, 0b11101110, 0b10000010, 0b00000011, 0b00000110, 0b00001100, 0b00011000, 0b00110000, 0b01100000, 0b11111010, 0b11111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character '3'
    { 0b00000000, 0b01111100, 0b11101110, 0b10000010, 0b00000011, 0b00010110, 0b00011110, 0b00000010, 0b00000010, 0b10000011, 0b11110110, 0b01111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character '4'
    { 0b00000000, 0b00001000, 0b00001100, 0b10001100, 0b10000100, 0b10001100, 0b10001100, 0b11111110, 0b10101100, 0b00001100, 0b00001100, 0b00000100, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character '5'
    { 0b00000000, 0b11111110, 0b11011010, 0b10000000, 0b10000000, 0b11110100, 0b11111110, 0b00000010, 0b00000010, 0b00000011, 0b10110110, 0b11111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character '6'
    { 0b00000000, 0b01111100, 0b11101000, 0b10000000, 0b10000000, 0b11101000, 0b11111110, 0b10000010, 0b10000010, 0b10000011, 0b11111110, 0b01111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character '7'
    { 0b00000000, 0b11111110, 0b10101110, 0b00000010, 0b00000011, 0b00000110, 0b00001100, 0b00011000, 0b00110000, 0b01100000, 0b11000000, 0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character '8'
    { 0b00000000, 0b01111100, 0b11101110, 0b10000010, 0b10000011, 0b11110110, 0b11111110, 0b10000010, 0b10000010, 0b10000011, 0b11111110, 0b01111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character '9'
    { 0b00000000, 0b01111100, 0b11101110, 0b10000010, 0b10000011, 0b11110110, 0b01111110, 0b00000011, 0b00000010, 0b00000010, 0b10110110, 0b11111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character 'a'
    { 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b01111100, 0b00101110, 0b00000010, 0b01111111, 0b11101110, 0b10000010, 0b11101110, 0b01111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character 'b'
    { 0b00000000, 0b10000000, 0b10000000, 0b10000000, 0b11111100, 0b11011110, 0b10000010, 0b10000011, 0b10000010, 0b10000010, 0b11111110, 0b11111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character 'c'
    { 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b01111100, 0b11101110, 0b10000010, 0b10000000, 0b10000000, 0b10000010, 0b11111110, 0b01111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character 'd'
    { 0b00000000, 0b00000010, 0b00000010, 0b00000011, 0b01111110, 0b11101110, 0b10000010, 0b10000011, 0b10000010, 0b10000010, 0b11111110, 0b01111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character 'e'
    { 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b01111100, 0b11101110, 0b10000010, 0b11111111, 0b11011010, 0b10000000, 0b11101000, 0b01111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character 'f'
    { 0b00000000, 0b00001110, 0b00011100, 0b00010000, 0b01111100, 0b00111000, 0b00010000, 0b00010000, 0b00010000, 0b00011000, 0b00010000, 0b00010000, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character 'g'
    { 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b01111110, 0b11101110, 0b10000010, 0b10000011, 0b10000010, 0b11111110, 0b01111110, 0b00000010, 0b00101110, 0b01111100, 0b00000000, 0b00000000 },
    // Character 'h'
    { 0b00000000, 0b10000000, 0b10000000, 0b10000000, 0b11111100, 0b11011110, 0b10000010, 0b10000011, 0b10000010, 0b10000010, 0b11000011, 0b10000010, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character 'i'
	{ 0b00000000, 0b00010000, 0b00010000, 0b00000000, 0b01110000, 0b00110000, 0b00010000, 0b00011000, 0b00010000, 0b00010000, 0b00111000, 0b01111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character 'j'
    { 0b00000000, 0b00000100, 0b00000000, 0b00000000, 0b00011100, 0b00011100, 0b00000100, 0b00001100, 0b00001100, 0b00000100, 0b00001100, 0b10001100, 0b11101000, 0b01111000, 0b00000000, 0b00000000 },
    // Character 'k'
    { 0b00000000, 0b01000000, 0b01100000, 0b01100000, 0b01000010, 0b01100110, 0b01101100, 0b01111000, 0b00111000, 0b01101100, 0b01100110, 0b00100010, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character 'l'
    { 0b00000000, 0b01110000, 0b00110000, 0b00010000, 0b00011000, 0b00010000, 0b00010000, 0b00010000, 0b00011000, 0b00010000, 0b00111000, 0b01111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character 'm'
    { 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b11101100, 0b11111110, 0b10010010, 0b10010011, 0b10111010, 0b10010010, 0b10010011, 0b10010010, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character 'n'
    { 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b11111100, 0b11011110, 0b10000010, 0b10000011, 0b10000010, 0b10000010, 0b11000011, 0b10000010, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character 'o'
    { 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b01111100, 0b11101110, 0b10000010, 0b10000011, 0b10000010, 0b10000010, 0b11111110, 0b01111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character 'p'
    { 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b11111100, 0b11011110, 0b10000010, 0b10000010, 0b10000010, 0b11111110, 0b11111100, 0b10000000, 0b10000000, 0b10000000, 0b00000000, 0b00000000 },
    // Character 'q'
    { 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b01111110, 0b11101110, 0b10000010, 0b10000011, 0b10000010, 0b11111110, 0b01111110, 0b00000011, 0b00000010, 0b00000010, 0b00000000, 0b00000000 },
    // Character 'r'
    { 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b01111100, 0b01101110, 0b01100010, 0b00100000, 0b01100000, 0b01100000, 0b01000000, 0b00100000, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character 's'
    { 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b01111110, 0b11101100, 0b10000000, 0b11111100, 0b00110110, 0b00000010, 0b10110110, 0b11111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character 't'
    { 0b00000000, 0b00010000, 0b00010000, 0b00010000, 0b01111110, 0b00111010, 0b00010000, 0b00010000, 0b00011000, 0b00010000, 0b00011100, 0b00001110, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character 'u'
    { 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b10000010, 0b10000010, 0b10000011, 0b10000010, 0b10000010, 0b11000011, 0b11011110, 0b01111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character 'v'
    { 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b10000010, 0b10000010, 0b10000011, 0b11000110, 0b11000110, 0b01111100, 0b00111000, 0b00010000, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character 'w'
    { 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b10000010, 0b10000010, 0b10010011, 0b10111010, 0b10010010, 0b10110011, 0b11111110, 0b01101100, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character 'x'
    { 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b10000010, 0b11000110, 0b01111100, 0b00111000, 0b00111000, 0b01101100, 0b11000110, 0b10000010, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
    // Character 'y'
    { 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b10000010, 0b10000010, 0b10000011, 0b10000010, 0b11000010, 0b11011110, 0b01111111, 0b00000010, 0b00101110, 0b01111100, 0b00000000, 0b00000000 },
    // Character 'z'
    { 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b11111110, 0b10111110, 0b00001100, 0b00011000, 0b00110000, 0b01100000, 0b11110100, 0b11111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000 },
	// Character ' '
	{ 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000 }

};


static uint8_t * currentVideo = (uint8_t*)0xB8000;
static uint64_t x = 0;
static uint64_t y = 0;
static char INTERLINE = 3;

// por ahora avanza automáticamente a la posición del sig. caracter, después vemos si eso tiene que hacerse acá
void drawChar(char c, uint32_t hexColor) {
	// salto de línea
	if(c == 37){
		x += VBE_mode_info->width - x;
		x = x % VBE_mode_info->width;
		y += CHAR_HEIGHT + INTERLINE;
		return;
	}

	// hago wrap si me paso del borde de la pantalla
	if(x >= VBE_mode_info->width){
		x = x % VBE_mode_info->width;
		y += CHAR_HEIGHT + INTERLINE;
	}

	uint8_t *bitmap = retro_font[c];
	for (uint64_t i = 0; i < CHAR_HEIGHT; i++) {
		for (uint64_t j = 0; j < CHAR_WIDTH; j++) {
			if (bitmap[i] & (1 << (7 - j))) {
				putPixel(hexColor, x + j, y + i);
			}
		}
	}

	x += CHAR_WIDTH;
}

/*
void printString(const char *str, uint32_t hexColor, uint64_t x, uint64_t y) {
	while (*str) {
		drawChar(*str++, hexColor, x, y);
		x += CHAR_WIDTH;
	}
}
*/